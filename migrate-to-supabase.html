<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>localStorage â†’ Supabase ë°ì´í„° ì´ì „</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 50px auto;
            padding: 20px;
        }
        .section {
            margin: 30px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .result {
            margin: 15px 0;
            padding: 15px;
            border-radius: 5px;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        button {
            padding: 12px 24px;
            font-size: 16px;
            cursor: pointer;
            margin: 5px;
            border: none;
            border-radius: 5px;
        }
        .btn-primary {
            background-color: #007bff;
            color: white;
        }
        .btn-primary:hover {
            background-color: #0056b3;
        }
        .btn-danger {
            background-color: #dc3545;
            color: white;
        }
        .btn-danger:hover {
            background-color: #c82333;
        }
        .progress {
            margin: 10px 0;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 5px;
        }
        pre {
            background-color: #f4f4f4;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>ğŸ”„ localStorage â†’ Supabase ë°ì´í„° ì´ì „</h1>
    
    <div class="section">
        <h2>1ë‹¨ê³„: í˜„ì¬ ë°ì´í„° í™•ì¸</h2>
        <button class="btn-primary" onclick="checkLocalStorage()">localStorage ë°ì´í„° í™•ì¸</button>
        <div id="checkResult"></div>
    </div>

    <div class="section">
        <h2>2ë‹¨ê³„: Supabaseë¡œ ë°ì´í„° ì´ì „</h2>
        <p><strong>ì£¼ì˜:</strong> ì´ ì‘ì—…ì€ ê¸°ì¡´ Supabase ë°ì´í„°ë¥¼ ë®ì–´ì”ë‹ˆë‹¤.</p>
        <button class="btn-primary" onclick="migrateQuestions()">ë¬¸ì œ ë°ì´í„° ì´ì „</button>
        <button class="btn-primary" onclick="migrateMembers()">íšŒì› ë°ì´í„° ì´ì „</button>
        <div id="migrateResult"></div>
    </div>

    <div class="section">
        <h2>3ë‹¨ê³„: ì´ì „ ê²°ê³¼ í™•ì¸</h2>
        <button class="btn-primary" onclick="verifyMigration()">Supabase ë°ì´í„° í™•ì¸</button>
        <div id="verifyResult"></div>
    </div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

        const supabaseUrl = 'https://eeyzenpolbrfmsamguvf.supabase.co';
        const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVleXplbnBvbGJyZm1zYW1ndXZmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMxNDg4NjcsImV4cCI6MjA3ODcyNDg2N30.cRxc6STLnhDI2Fm7jADLhhdko50esBNuYOkha3BC0-0';
        const supabase = createClient(supabaseUrl, supabaseAnonKey);

        // localStorageì—ì„œ ë°ì´í„° ì½ê¸°
        function getLocalStorageData(key) {
            try {
                const data = localStorage.getItem(key);
                return data ? JSON.parse(data) : null;
            } catch (error) {
                console.error(`localStorage ì½ê¸° ì‹¤íŒ¨ (${key}):`, error);
                return null;
            }
        }

        // 1ë‹¨ê³„: í˜„ì¬ ë°ì´í„° í™•ì¸
        window.checkLocalStorage = function() {
            const resultDiv = document.getElementById('checkResult');
            resultDiv.innerHTML = '<p>í™•ì¸ ì¤‘...</p>';

            const questions = getLocalStorageData('questions');
            const members = getLocalStorageData('members');
            const wrongAnswers = getLocalStorageData('wrongAnswers');
            const examResults = getLocalStorageData('examResults');

            let html = '<div class="result info">';
            html += '<h3>ğŸ“Š localStorage ë°ì´í„° í˜„í™©</h3>';
            html += `<p><strong>ë¬¸ì œ (questions):</strong> ${questions ? questions.length : 0}ê°œ</p>`;
            html += `<p><strong>íšŒì› (members):</strong> ${members ? members.length : 0}ê°œ</p>`;
            html += `<p><strong>ì˜¤ë‹µë…¸íŠ¸ (wrongAnswers):</strong> ${wrongAnswers ? wrongAnswers.length : 0}ê°œ</p>`;
            html += `<p><strong>ì‹œí—˜ ê²°ê³¼ (examResults):</strong> ${examResults ? examResults.length : 0}ê°œ</p>`;
            html += '</div>';

            if (questions && questions.length > 0) {
                html += '<div class="result info">';
                html += '<h4>ì²« ë²ˆì§¸ ë¬¸ì œ ìƒ˜í”Œ:</h4>';
                html += `<pre>${JSON.stringify(questions[0], null, 2)}</pre>`;
                html += '</div>';
            }

            resultDiv.innerHTML = html;
        };

        // 2ë‹¨ê³„: ë¬¸ì œ ë°ì´í„° ì´ì „
        window.migrateQuestions = async function() {
            const resultDiv = document.getElementById('migrateResult');
            resultDiv.innerHTML = '<p>ì´ì „ ì¤‘...</p>';

            try {
                const questions = getLocalStorageData('questions');
                
                if (!questions || questions.length === 0) {
                    resultDiv.innerHTML = '<div class="result error"><h3>âŒ ì˜¤ë¥˜</h3><p>localStorageì— ë¬¸ì œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p></div>';
                    return;
                }

                // ê¸°ì¡´ ë°ì´í„° ì‚­ì œ (ì„ íƒì‚¬í•­)
                const { error: deleteError } = await supabase
                    .from('questions')
                    .delete()
                    .neq('id', 0); // ëª¨ë“  ë°ì´í„° ì‚­ì œ

                if (deleteError && deleteError.code !== 'PGRST116') {
                    console.warn('ê¸°ì¡´ ë°ì´í„° ì‚­ì œ ê²½ê³ :', deleteError);
                }

                // ë°ì´í„° ì´ì „ (ë°°ì¹˜ë¡œ ë‚˜ëˆ ì„œ)
                const batchSize = 100;
                let successCount = 0;
                let errorCount = 0;

                for (let i = 0; i < questions.length; i += batchSize) {
                    const batch = questions.slice(i, i + batchSize);
                    
                    // hasImage í•„ë“œ ì¶”ê°€ (imageUrlì´ ìˆìœ¼ë©´ true)
                    const processedBatch = batch.map(q => ({
                        ...q,
                        hasImage: !!q.imageUrl
                    }));

                    const { data, error } = await supabase
                        .from('questions')
                        .insert(processedBatch);

                    if (error) {
                        console.error(`ë°°ì¹˜ ${i / batchSize + 1} ì˜¤ë¥˜:`, error);
                        errorCount += batch.length;
                    } else {
                        successCount += batch.length;
                    }

                    // ì§„í–‰ ìƒí™© ì—…ë°ì´íŠ¸
                    resultDiv.innerHTML = `
                        <div class="progress">
                            <p>ì§„í–‰ ì¤‘... ${Math.min(i + batchSize, questions.length)} / ${questions.length}</p>
                        </div>
                    `;
                }

                resultDiv.innerHTML = `
                    <div class="result success">
                        <h3>âœ… ë¬¸ì œ ë°ì´í„° ì´ì „ ì™„ë£Œ!</h3>
                        <p>ì„±ê³µ: ${successCount}ê°œ</p>
                        <p>ì‹¤íŒ¨: ${errorCount}ê°œ</p>
                    </div>
                `;
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="result error">
                        <h3>âŒ ì´ì „ ì‹¤íŒ¨</h3>
                        <p>ì˜¤ë¥˜: ${error.message}</p>
                    </div>
                `;
            }
        };

        // íšŒì› ë°ì´í„° ì´ì „
        window.migrateMembers = async function() {
            const resultDiv = document.getElementById('migrateResult');
            resultDiv.innerHTML = '<p>ì´ì „ ì¤‘...</p>';

            try {
                const members = getLocalStorageData('members');
                
                if (!members || members.length === 0) {
                    resultDiv.innerHTML = '<div class="result error"><h3>âŒ ì˜¤ë¥˜</h3><p>localStorageì— íšŒì› ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p></div>';
                    return;
                }

                // ê¸°ì¡´ ë°ì´í„° ì‚­ì œ
                const { error: deleteError } = await supabase
                    .from('members')
                    .delete()
                    .neq('id', '');

                // ë°ì´í„° ì´ì „
                const { data, error } = await supabase
                    .from('members')
                    .insert(members);

                if (error) {
                    throw error;
                }

                resultDiv.innerHTML = `
                    <div class="result success">
                        <h3>âœ… íšŒì› ë°ì´í„° ì´ì „ ì™„ë£Œ!</h3>
                        <p>${members.length}ê°œ íšŒì› ë°ì´í„°ê°€ ì´ì „ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
                    </div>
                `;
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="result error">
                        <h3>âŒ ì´ì „ ì‹¤íŒ¨</h3>
                        <p>ì˜¤ë¥˜: ${error.message}</p>
                    </div>
                `;
            }
        };

        // 3ë‹¨ê³„: ì´ì „ ê²°ê³¼ í™•ì¸
        window.verifyMigration = async function() {
            const resultDiv = document.getElementById('verifyResult');
            resultDiv.innerHTML = '<p>í™•ì¸ ì¤‘...</p>';

            try {
                const { data: questions, error: qError } = await supabase
                    .from('questions')
                    .select('*', { count: 'exact' });

                const { data: members, error: mError } = await supabase
                    .from('members')
                    .select('*', { count: 'exact' });

                if (qError) throw qError;
                if (mError) throw mError;

                let html = '<div class="result success">';
                html += '<h3>âœ… Supabase ë°ì´í„° í™•ì¸</h3>';
                html += `<p><strong>ë¬¸ì œ:</strong> ${questions.length}ê°œ</p>`;
                html += `<p><strong>íšŒì›:</strong> ${members.length}ê°œ</p>`;
                html += '</div>';

                if (questions.length > 0) {
                    html += '<div class="result info">';
                    html += '<h4>ì²« ë²ˆì§¸ ë¬¸ì œ ìƒ˜í”Œ:</h4>';
                    html += `<pre>${JSON.stringify(questions[0], null, 2)}</pre>`;
                    html += '</div>';
                }

                resultDiv.innerHTML = html;
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="result error">
                        <h3>âŒ í™•ì¸ ì‹¤íŒ¨</h3>
                        <p>ì˜¤ë¥˜: ${error.message}</p>
                    </div>
                `;
            }
        };
    </script>
</body>
</html>

