import { useState, useEffect, useMemo } from 'react';
import type { Question } from '../types';
import ScientificCalculator from '../components/ScientificCalculator';
import { getStandardTitle } from '../data/examStandards';
import {
  getCurrentExamSession,
  saveCurrentExamSession,
  clearCurrentExamSession,
  addWrongAnswer,
  updateCorrectAnswer,
  removeWrongAnswer,
  addExamResult,
  updateStatistics,
  getWrongAnswers,
  getCurrentUser,
} from '../services/storage';
import type { ExamSession, ExamResult, WrongAnswer } from '../types';
import LatexRenderer from '../components/LatexRenderer';
import FeedbackBoard from '../components/FeedbackBoard';

interface ExamProps {
  questions: Question[];
  onComplete: (answers: (number | null)[], mode?: 'random' | 'category' | 'wrong') => void;
  onExit: () => void;
}

export default function Exam({ questions, onComplete, onExit }: ExamProps) {
  // ëœë¤ ëª¨ë“œì¼ ë•Œ ì¹´í…Œê³ ë¦¬ë³„ë¡œ ì •ë ¬ (1-20: ì „ê¸°ì´ë¡ , 21-40: ì „ê¸°ê¸°ê¸°, 41-60: ì „ê¸°ì„¤ë¹„)
  const sortedQuestions = useMemo(() => {
    // ì¹´í…Œê³ ë¦¬ë³„ë¡œ ê·¸ë£¹í™”
    const categoryGroups: Record<string, Question[]> = {
      'ì „ê¸°ì´ë¡ ': [],
      'ì „ê¸°ê¸°ê¸°': [],
      'ì „ê¸°ì„¤ë¹„': [],
      'ê¸°íƒ€': [],
    };

    questions.forEach(q => {
      const category = q.category || 'ê¸°íƒ€';
      if (!categoryGroups[category]) {
        categoryGroups[category] = [];
      }
      categoryGroups[category].push(q);
    });

    // ì¹´í…Œê³ ë¦¬ ìˆœì„œëŒ€ë¡œ ì •ë ¬
    const categoryOrder = ['ì „ê¸°ì´ë¡ ', 'ì „ê¸°ê¸°ê¸°', 'ì „ê¸°ì„¤ë¹„', 'ê¸°íƒ€'];
    const sorted: Question[] = [];
    
    categoryOrder.forEach(category => {
      if (categoryGroups[category] && categoryGroups[category].length > 0) {
        sorted.push(...categoryGroups[category]);
      }
    });

    return sorted.length > 0 ? sorted : questions;
  }, [questions]);

  // ì •ë ¬ëœ ë¬¸ì œ ì‚¬ìš©
  const displayQuestions = sortedQuestions;

  // ì´ˆê¸° ì„¸ì…˜ ë³µì›
  const savedSession = getCurrentExamSession();
  const shouldRestoreSession = savedSession && 
    savedSession.questions && 
    savedSession.questions.length > 0 &&
    displayQuestions.length > 0 &&
    savedSession.questions.length === displayQuestions.length;
  
  let initialAnswers: { [key: number]: number } = {};
  let initialStartTime = Date.now();
  let initialRemainingTime = 60 * 60; // 60ë¶„ = 3600ì´ˆ
  let initialMode: 'random' | 'category' | 'wrong' = 'random';
  const duration = 60 * 60; // 60ë¶„
  
  if (shouldRestoreSession) {
    // ë¬¸ì œ IDê°€ ì¼ì¹˜í•˜ëŠ”ì§€ í™•ì¸ (ì •ë ¬ëœ ë¬¸ì œ ê¸°ì¤€)
    const savedQuestionIds = savedSession.questions.map(q => q.id).sort();
    const currentQuestionIds = displayQuestions.map(q => q.id).sort();
    
    if (savedQuestionIds.length === currentQuestionIds.length &&
        savedQuestionIds.every((id, index) => id === currentQuestionIds[index])) {
      initialAnswers = savedSession.answers || {};
      initialMode = savedSession.mode || 'random';
      
      // í’€ì§€ ëª»í•œ ë¬¸ì œ ìˆ˜ ê³„ì‚°
      const answeredCount = Object.keys(initialAnswers).length;
      const unansweredCount = displayQuestions.length - answeredCount;
      
      // ë‹µë³€ ê¸°ë¡ì´ ì—†ìœ¼ë©´ ìƒˆë¡œìš´ ì‹œì‘ ì‹œê°„ìœ¼ë¡œ ì„¤ì •í•˜ê³  60ë¶„ ë¶€ì—¬
      if (answeredCount === 0) {
        initialStartTime = Date.now(); // ìƒˆë¡œìš´ ì‹œì‘ ì‹œê°„
        initialRemainingTime = 60 * 60; // 60ë¶„
        console.log(`â° ì„¸ì…˜ ë³µì›: ë‹µë³€ ê¸°ë¡ ì—†ìŒ. ìƒˆë¡œìš´ ì‹œí—˜ìœ¼ë¡œ ì‹œì‘ (60ë¶„)`);
      } else {
        // ë‹µë³€ ê¸°ë¡ì´ ìˆìœ¼ë©´ ì´ì „ ì„¸ì…˜ì˜ ì‹œì‘ ì‹œê°„ ìœ ì§€
        initialStartTime = savedSession.startTime;
        // í’€ì§€ ëª»í•œ ë¬¸ì œë‹¹ 1ë¶„(60ì´ˆ)ì”© ì‹œê°„ ë¶€ì—¬
        const additionalTime = unansweredCount * 60;
        initialRemainingTime = additionalTime;
        
        if (unansweredCount > 0) {
          console.log(`â° ì„¸ì…˜ ë³µì›: í’€ì§€ ëª»í•œ ë¬¸ì œ ${unansweredCount}ê°œì— ëŒ€í•´ ${unansweredCount}ë¶„ ì‹œê°„ì´ ë¶€ì—¬ë˜ì—ˆìŠµë‹ˆë‹¤.`);
        } else {
          console.log(`â° ì„¸ì…˜ ë³µì›: ëª¨ë“  ë¬¸ì œë¥¼ í’€ì—ˆìŠµë‹ˆë‹¤.`);
        }
      }
    }
  }

  const [currentIndex, setCurrentIndex] = useState(0);
  const [answers, setAnswers] = useState<{ [key: number]: number }>(initialAnswers);
  const [startTime, setStartTime] = useState(initialStartTime);
  const [remainingTime, setRemainingTime] = useState(initialRemainingTime);
  const [examMode, setExamMode] = useState<'random' | 'category' | 'wrong'>(initialMode);
  const [isTimeReset, setIsTimeReset] = useState(false); // ì‹œê°„ ì´ˆê¸°í™” ì—¬ë¶€
  const [showScoreModal, setShowScoreModal] = useState(false);
  const [showCalculator, setShowCalculator] = useState(false); // ê³„ì‚°ê¸° í‘œì‹œ ì—¬ë¶€
  const [showFeedbackBoard, setShowFeedbackBoard] = useState(false); // ì œë³´ ê²Œì‹œíŒ í‘œì‹œ ì—¬ë¶€
  const [showHint, setShowHint] = useState(false); // íŒíŠ¸ ëª¨ë‹¬ í‘œì‹œ ì—¬ë¶€
  const [showPrintOptions, setShowPrintOptions] = useState(false); // ì¸ì‡„ ì˜µì…˜ ëª¨ë‹¬ í‘œì‹œ ì—¬ë¶€
  const [printOption, setPrintOption] = useState<'questionsOnly' | 'withAnswers' | 'withExplanations'>('questionsOnly'); // ì¸ì‡„ ì˜µì…˜
  const [scoreResult, setScoreResult] = useState<{
    total: number;
    correct: number;
    wrong: number;
    unanswered: number;
    score: number;
    percentage: number;
    encouragement?: string; // ê²©ë ¤ ë©”ì‹œì§€
    answeredCount?: number; // ì‘ì‹œí•œ ë¬¸ì œ ìˆ˜ (ì˜¤ë‹µë…¸íŠ¸ ëª¨ë“œìš©)
  } | null>(null);

  // ì„¸ì…˜ ë³µì› (questions propì´ ë³€ê²½ë  ë•Œë§ˆë‹¤ í™•ì¸)
  useEffect(() => {
    if (displayQuestions.length === 0) return; 
    
    const savedSession = getCurrentExamSession();
    if (savedSession && savedSession.questions && savedSession.questions.length > 0) {
      // ë¬¸ì œ IDê°€ ì¼ì¹˜í•˜ëŠ”ì§€ í™•ì¸
      const savedQuestionIds = savedSession.questions.map(q => q.id).sort();
      const currentQuestionIds = displayQuestions.map(q => q.id).sort();
      
      // ë¬¸ì œ IDê°€ ëª¨ë‘ ì¼ì¹˜í•˜ë©´ ì„¸ì…˜ ë³µì›
      if (
        savedQuestionIds.length === currentQuestionIds.length &&
        savedQuestionIds.every((id, index) => id === currentQuestionIds[index])
      ) {
        const restoredAnswers = savedSession.answers || {};
        setAnswers(restoredAnswers);
        setExamMode(savedSession.mode || 'random');
        
        // í’€ì§€ ëª»í•œ ë¬¸ì œ ìˆ˜ ê³„ì‚°
        const answeredCount = Object.keys(restoredAnswers).length;
        const unansweredCount = displayQuestions.length - answeredCount;
        
        // ë‹µë³€ ê¸°ë¡ì´ ì—†ìœ¼ë©´ ìƒˆë¡œìš´ ì‹œì‘ ì‹œê°„ìœ¼ë¡œ ì„¤ì •í•˜ê³  60ë¶„ ë¶€ì—¬
        if (answeredCount === 0) {
          setStartTime(Date.now()); // ìƒˆë¡œìš´ ì‹œì‘ ì‹œê°„
          setRemainingTime(60 * 60); // 60ë¶„
          console.log(`â° ì„¸ì…˜ ë³µì›: ë‹µë³€ ê¸°ë¡ ì—†ìŒ. ìƒˆë¡œìš´ ì‹œí—˜ìœ¼ë¡œ ì‹œì‘ (60ë¶„)`);
        } else {
          // ë‹µë³€ ê¸°ë¡ì´ ìˆìœ¼ë©´ ì´ì „ ì„¸ì…˜ì˜ ì‹œì‘ ì‹œê°„ ìœ ì§€
          setStartTime(savedSession.startTime);
          // í’€ì§€ ëª»í•œ ë¬¸ì œë‹¹ 1ë¶„(60ì´ˆ)ì”© ì‹œê°„ ë¶€ì—¬
          const additionalTime = unansweredCount * 60;
          setRemainingTime(additionalTime);
          
          if (unansweredCount > 0) {
            console.log(`â° ì„¸ì…˜ ë³µì›: í’€ì§€ ëª»í•œ ë¬¸ì œ ${unansweredCount}ê°œì— ëŒ€í•´ ${unansweredCount}ë¶„ ì‹œê°„ì´ ë¶€ì—¬ë˜ì—ˆìŠµë‹ˆë‹¤.`);
          } else {
            console.log(`â° ì„¸ì…˜ ë³µì›: ëª¨ë“  ë¬¸ì œë¥¼ í’€ì—ˆìŠµë‹ˆë‹¤.`);
          }
        }
      }
    }
  }, [questions, duration]);

  // ì„¸ì…˜ ìë™ ì €ì¥
  useEffect(() => {
    const currentUserId = getCurrentUser();
    const session: ExamSession = {
      questions: displayQuestions,
      answers,
      startTime,
      mode: examMode,
      category: undefined,
      userId: currentUserId || undefined, // í˜„ì¬ ì‚¬ìš©ì ID ì €ì¥
    };
    saveCurrentExamSession(session);
  }, [answers, displayQuestions, startTime, examMode]);

  // íƒ€ì´ë¨¸
  useEffect(() => {
    if (displayQuestions.length === 0) return;

    const timer = setInterval(() => {
      // ì‹œê°„ ì´ˆê¸°í™”ë¥¼ í•œ ê²½ìš°: ì›ë˜ ì‹œí—˜ ì‹œê°„(60ë¶„) ê¸°ì¤€ìœ¼ë¡œ ê³„ì‚°
      if (isTimeReset) {
        const elapsed = Math.floor((Date.now() - startTime) / 1000);
        const remaining = Math.max(0, duration - elapsed);
        setRemainingTime(remaining);
        
        // ì‹œê°„ì´ ëª¨ë‘ ì†Œì§„ë˜ë©´ ìë™ ì œì¶œ
        if (remaining === 0) {
          clearInterval(timer);
          alert('ì‹œí—˜ ì‹œê°„ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ìë™ìœ¼ë¡œ ì œì¶œë©ë‹ˆë‹¤.');
          handleSubmit(true);
        }
      } else {
        // ì‹œê°„ ì´ˆê¸°í™”ë¥¼ í•˜ì§€ ì•Šì€ ê²½ìš°: í’€ì§€ ëª»í•œ ë¬¸ì œë‹¹ 1ë¶„ì”© ì‹œê°„ ë¶€ì—¬
        const answeredCount = Object.keys(answers).length;
        const unansweredCount = displayQuestions.length - answeredCount;
        
        // ë‹µë³€ ê¸°ë¡ì´ ì—†ìœ¼ë©´ 60ë¶„ë¶€í„° ì‹œì‘
        if (answeredCount === 0) {
          const elapsed = Math.floor((Date.now() - startTime) / 1000);
          const remaining = Math.max(0, duration - elapsed);
          setRemainingTime(remaining);
          
          // ì‹œê°„ì´ ëª¨ë‘ ì†Œì§„ë˜ë©´ ìë™ ì œì¶œ
          if (remaining === 0) {
            clearInterval(timer);
            alert('ì‹œí—˜ ì‹œê°„ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ìë™ìœ¼ë¡œ ì œì¶œë©ë‹ˆë‹¤.');
            handleSubmit(true);
          }
        } else {
          // ë‹µë³€ ê¸°ë¡ì´ ìˆìœ¼ë©´ í’€ì§€ ëª»í•œ ë¬¸ì œë‹¹ 1ë¶„ì”© ì‹œê°„ ë¶€ì—¬
          // ì‹¤ì œ ê²½ê³¼ ì‹œê°„ì„ ê³„ì‚°í•˜ì—¬ ì‹œê°„ì´ íë¥´ë„ë¡ í•¨
          const elapsed = Math.floor((Date.now() - startTime) / 1000);
          
          // í’€ì§€ ëª»í•œ ë¬¸ì œë‹¹ 1ë¶„(60ì´ˆ)ì”© ì‹œê°„ ë¶€ì—¬
          const totalTime = unansweredCount * 60;
          const remaining = Math.max(0, totalTime - elapsed);
          setRemainingTime(remaining);
          
          // ì‹œê°„ì´ ëª¨ë‘ ì†Œì§„ë˜ë©´ ìë™ ì œì¶œ
          if (remaining === 0) {
            clearInterval(timer);
            alert('ì‹œí—˜ ì‹œê°„ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ìë™ìœ¼ë¡œ ì œì¶œë©ë‹ˆë‹¤.');
            handleSubmit(true);
          }
        }
      }
    }, 1000);

    return () => clearInterval(timer);
  }, [displayQuestions.length, answers, startTime, duration, isTimeReset]);

  const formatTime = (seconds: number): string => {
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
  };

  const handleAnswerSelect = (answer: number) => {
    setAnswers({
      ...answers,
      [displayQuestions[currentIndex].id]: answer,
    });
  };

  const handleNext = () => {
    if (currentIndex < displayQuestions.length - 1) {
      setCurrentIndex(currentIndex + 1);
    }
  };

  const handlePrevious = () => {
    if (currentIndex > 0) {
      setCurrentIndex(currentIndex - 1);
    }
  };

  const handleNavigate = (index: number) => {
    setCurrentIndex(index);
  };

  const handleSubmit = (autoSubmit = false) => {
    if (!autoSubmit) {
      const unanswered = questions.filter(q => !answers[q.id]).length;
    if (unanswered > 0) {
        const confirmed = window.confirm(
        `ì•„ì§ ${unanswered}ë¬¸ì œê°€ ë¯¸ë‹µë³€ ìƒíƒœì…ë‹ˆë‹¤.\nì œì¶œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`
      );
        if (!confirmed) return;
    } else {
        const confirmed = window.confirm('ì‹œí—˜ì„ ì œì¶œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');
        if (!confirmed) return;
      }
    }

    // ê²°ê³¼ ê³„ì‚°
    let correctCount = 0;
    const wrongQuestions: Question[] = [];

    console.log('ğŸ“Š ì‹œí—˜ ì œì¶œ ì‹œì‘ - ì˜¤ë‹µ ì €ì¥ ë¡œì§ ì‹¤í–‰');
    console.log('ğŸ“‹ ì´ ë¬¸ì œ ìˆ˜:', questions.length);
    console.log('ğŸ“‹ ë‹µë³€í•œ ë¬¸ì œ ìˆ˜:', Object.keys(answers).length);
    console.log('ğŸ“‹ ë‹µë³€ ë°ì´í„°:', answers);
    console.log('ğŸ“‹ ì‹œí—˜ ëª¨ë“œ:', examMode);

    // ì˜¤ë‹µë…¸íŠ¸ ëª¨ë“œì¼ ë•ŒëŠ” ë‹¤ë¥¸ ë¡œì§ ì‚¬ìš©
    const isWrongMode = examMode === 'wrong';

    displayQuestions.forEach(q => {
      const userAnswer = answers[q.id];
      console.log(`ë¬¸ì œ ${q.id} (${q.category}): ì‚¬ìš©ì ë‹µë³€=${userAnswer}, ì •ë‹µ=${q.answer}`);
      
      if (userAnswer === q.answer) {
        correctCount++;
        // ì˜¤ë‹µë…¸íŠ¸ ëª¨ë“œì¼ ë•ŒëŠ” ì •ë‹µì„ ë§ì¶˜ ë¬¸ì œë¥¼ ì¦‰ì‹œ ì œê±°
        if (isWrongMode) {
          removeWrongAnswer(q.id);
          console.log(`âœ… ì •ë‹µ: ë¬¸ì œ ${q.id} (${q.category}) - ì˜¤ë‹µë…¸íŠ¸ì—ì„œ ì¦‰ì‹œ ì œê±°`);
        } else {
          // ì¼ë°˜ ëª¨ë“œì¼ ë•ŒëŠ” correctStreak++, 3íšŒ ì—°ì† ì‹œ ì˜¤ë‹µë…¸íŠ¸ì—ì„œ ì œê±°
          updateCorrectAnswer(q.id);
          console.log(`âœ… ì •ë‹µ: ë¬¸ì œ ${q.id} (${q.category})`);
        }
      } else {
        wrongQuestions.push(q);
        // ì˜¤ë‹µ ì²˜ë¦¬: wrongCount++, correctStreak=0
        // ì‚¬ìš©ìê°€ ë‹µë³€ì„ ì„ íƒí–ˆê³ , í‹€ë¦° ê²½ìš°ì—ë§Œ ì˜¤ë‹µ ì €ì¥ (ì±„ì  ê¸°ì¤€)
        if (userAnswer !== undefined && userAnswer !== null && userAnswer !== q.answer) {
          const wrongAnswer: WrongAnswer = {
            questionId: q.id,
            question: q,
            userAnswer,
            timestamp: Date.now(),
            wrongCount: 1,
            correctStreak: 0,
          };
          console.log(`âŒ ì˜¤ë‹µ ì €ì¥ ì‹œë„: ë¬¸ì œ ${q.id} (${q.category}) - ì‚¬ìš©ì ë‹µë³€: ${userAnswer}, ì •ë‹µ: ${q.answer}`);
          addWrongAnswer(wrongAnswer);
          console.log(`âœ… ì˜¤ë‹µ ì €ì¥ ì™„ë£Œ: ë¬¸ì œ ${q.id} (${q.category})`);
        } else {
          console.log(`âš ï¸ ì˜¤ë‹µ ì €ì¥ ì•ˆë¨: ë¬¸ì œ ${q.id} (${q.category}) - ì‚¬ìš©ì ë‹µë³€: ${userAnswer} (ë‹µë³€ ì—†ìŒ)`);
        }
      }
    });

    console.log('ğŸ“Š ì˜¤ë‹µ ì €ì¥ ì™„ë£Œ - ì €ì¥ëœ ì˜¤ë‹µ ìˆ˜:', getWrongAnswers().length);

    // ExamResult ì €ì¥
    const result: ExamResult = {
      totalQuestions: displayQuestions.length,
      correctAnswers: correctCount,
      wrongQuestions,
      allQuestions: displayQuestions, // ì „ì²´ ë¬¸ì œ ëª©ë¡ ì¶”ê°€ (í†µê³„ ê³„ì‚°ìš©)
      timestamp: Date.now(),
      mode: examMode,
      category: undefined,
    };

    addExamResult(result);
    updateStatistics(result);
    clearCurrentExamSession();

    // ê²°ê³¼ í˜ì´ì§€ë¡œ ì´ë™ (answersë¥¼ ë°°ì—´ë¡œ ë³€í™˜)
    const answersArray: (number | null)[] = displayQuestions.map(q => answers[q.id] || null);
    onComplete(answersArray, examMode);
  };

  // ë‚˜ê°€ê¸° ë²„íŠ¼: ìë™ ì €ì¥ + ë‚˜ê°€ê¸°
  const handleExit = () => {
    try {
      const currentUserId = getCurrentUser();
      // ì‹œí—˜ í˜„í™© ëª…ì‹œì ìœ¼ë¡œ ì €ì¥ (ì‚¬ìš©ìê°€ ì €ì¥ ë²„íŠ¼ì„ ëˆ„ë¥´ì§€ ì•Šì•„ë„ ìë™ ì €ì¥)
      const session: ExamSession = {
        questions: displayQuestions,
        answers,
        startTime,
        mode: examMode,
        category: undefined,
        userId: currentUserId || undefined, // í˜„ì¬ ì‚¬ìš©ì ID ì €ì¥
      };
      
      // ì„¸ì…˜ ì €ì¥ (ì—ëŸ¬ ì²˜ë¦¬ í¬í•¨)
      saveCurrentExamSession(session);
      
      const answeredCount = Object.keys(answers).length;
      const totalCount = displayQuestions.length;
      
      // ì €ì¥ ì™„ë£Œ ë¡œê·¸
      console.log(`ğŸ’¾ ì‹œí—˜ í˜„í™© ìë™ ì €ì¥ ì™„ë£Œ: ${answeredCount}/${totalCount} ë¬¸ì œ í’€ì´ ì™„ë£Œ`);
      
      // ì €ì¥ ì™„ë£Œ í›„ ë‚˜ê°€ê¸°
      onExit();
    } catch (error) {
      console.error('âŒ ì‹œí—˜ í˜„í™© ì €ì¥ ì‹¤íŒ¨:', error);
      // ì €ì¥ ì‹¤íŒ¨í•´ë„ ë‚˜ê°€ê¸°ëŠ” ì§„í–‰ (ì‚¬ìš©ì ê²½í—˜)
      alert('âš ï¸ ì‹œí—˜ í˜„í™© ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì§„í–‰ ìƒí™©ì´ ì†ì‹¤ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
      onExit();
    }
  };
  
  // ì €ì¥í•˜ê¸° ë²„íŠ¼
  const handleSave = () => {
    const currentUserId = getCurrentUser();
    // ì„¸ì…˜ ì €ì¥ (ì´ë¯¸ useEffectì—ì„œ ìë™ ì €ì¥ë˜ì§€ë§Œ ëª…ì‹œì ìœ¼ë¡œ ì €ì¥)
    const session: ExamSession = {
      questions: displayQuestions,
      answers,
      startTime,
      mode: examMode,
      category: undefined,
      userId: currentUserId || undefined, // í˜„ì¬ ì‚¬ìš©ì ID ì €ì¥
    };
    saveCurrentExamSession(session);
    
    alert(`ğŸ’¾ ì €ì¥ ì™„ë£Œ!\n\në‹µë³€í•œ ë¬¸ì œ: ${Object.keys(answers).length}/${displayQuestions.length}ê°œ`);
  };

  // ì‹œê°„ ì´ˆê¸°í™” ë²„íŠ¼
  const handleResetTime = () => {
    if (window.confirm('â° ì‹œí—˜ ì‹œê°„ì„ 60ë¶„ìœ¼ë¡œ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\ní˜„ì¬ ì§„í–‰ ìƒí™©ì€ ìœ ì§€ë©ë‹ˆë‹¤.')) {
      // ì‹œì‘ ì‹œê°„ì„ í˜„ì¬ ì‹œê°„ìœ¼ë¡œ ì¬ì„¤ì •
      const newStartTime = Date.now();
      setStartTime(newStartTime);
      
      // ë‚¨ì€ ì‹œê°„ì„ 60ë¶„(3600ì´ˆ)ìœ¼ë¡œ ì„¤ì •
      setRemainingTime(60 * 60);
      
      // ì‹œê°„ ì´ˆê¸°í™” í”Œë˜ê·¸ ì„¤ì •
      setIsTimeReset(true);
      
      const currentUserId = getCurrentUser();
      // ì„¸ì…˜ ì €ì¥
      const session: ExamSession = {
        questions: displayQuestions,
        answers,
        startTime: newStartTime,
        mode: examMode,
        category: undefined,
        userId: currentUserId || undefined, // í˜„ì¬ ì‚¬ìš©ì ID ì €ì¥
      };
      saveCurrentExamSession(session);
      
      alert('âœ… ì‹œí—˜ ì‹œê°„ì´ 60ë¶„ìœ¼ë¡œ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
    }
  };

  // ì±„ì  ë²„íŠ¼
  const handleScore = () => {
    const currentUserId = getCurrentUser();
    // ì„¸ì…˜ ìë™ ì €ì¥
    const session: ExamSession = {
      questions,
      answers,
      startTime,
      mode: examMode,
      category: undefined,
      userId: currentUserId || undefined, // í˜„ì¬ ì‚¬ìš©ì ID ì €ì¥
    };
    saveCurrentExamSession(session);

    console.log('ğŸ“Š ì±„ì í•˜ê¸° ë²„íŠ¼ í´ë¦­ - ì˜¤ë‹µ ì €ì¥ ë¡œì§ ì‹¤í–‰');
    console.log('ğŸ“‹ ì´ ë¬¸ì œ ìˆ˜:', questions.length);
    console.log('ğŸ“‹ ë‹µë³€í•œ ë¬¸ì œ ìˆ˜:', Object.keys(answers).length);
    console.log('ğŸ“‹ ë‹µë³€ ë°ì´í„°:', answers);
    console.log('ğŸ“‹ ì‹œí—˜ ëª¨ë“œ:', examMode);

    // ì˜¤ë‹µë…¸íŠ¸ ëª¨ë“œì¼ ë•ŒëŠ” ë‹¤ë¥¸ ì±„ì  ë¡œì§ ì‚¬ìš©
    const isWrongMode = examMode === 'wrong';

    // ì±„ì  ê²°ê³¼ ê³„ì‚° ë° ì˜¤ë‹µ ì €ì¥
    let correctCount = 0;
    let wrongCount = 0;
    let unansweredCount = 0;
    let savedWrongCount = 0;
    let answeredCount = 0; // ì‘ì‹œí•œ ë¬¸ì œ ìˆ˜ (ì˜¤ë‹µë…¸íŠ¸ ëª¨ë“œìš©)

    displayQuestions.forEach(q => {
      const userAnswer = answers[q.id];
      if (userAnswer === undefined || userAnswer === null) {
        unansweredCount++;
      } else {
        answeredCount++; // ì‘ì‹œí•œ ë¬¸ì œ ì¹´ìš´íŠ¸
        if (userAnswer === q.answer) {
          correctCount++;
          // ì˜¤ë‹µë…¸íŠ¸ ëª¨ë“œì¼ ë•ŒëŠ” ì •ë‹µì„ ë§ì¶˜ ë¬¸ì œë¥¼ ì¦‰ì‹œ ì œê±°
          if (isWrongMode) {
            // ì˜¤ë‹µë…¸íŠ¸ì— ì‹¤ì œë¡œ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸ í›„ ì œê±°
            const currentWrongAnswers = getWrongAnswers();
            const existsInWrongAnswers = currentWrongAnswers.some(wa => wa.questionId === q.id);
            if (existsInWrongAnswers) {
              removeWrongAnswer(q.id);
              console.log(`âœ… ì •ë‹µ: ë¬¸ì œ ${q.id} (${q.category}) - ì˜¤ë‹µë…¸íŠ¸ì—ì„œ ì¦‰ì‹œ ì œê±°`);
            } else {
              console.log(`â„¹ï¸ ì •ë‹µ: ë¬¸ì œ ${q.id} (${q.category}) - ì´ë¯¸ ì˜¤ë‹µë…¸íŠ¸ì— ì—†ìŒ`);
            }
          } else {
            // ì¼ë°˜ ëª¨ë“œì¼ ë•ŒëŠ” correctStreak++, 3íšŒ ì—°ì† ì‹œ ì˜¤ë‹µë…¸íŠ¸ì—ì„œ ì œê±°
            updateCorrectAnswer(q.id);
            console.log(`âœ… ì •ë‹µ: ë¬¸ì œ ${q.id} (${q.category})`);
          }
        } else {
          wrongCount++;
          // ì˜¤ë‹µ ì²˜ë¦¬: wrongCount++, correctStreak=0
          // ì‚¬ìš©ìê°€ ë‹µë³€ì„ ì„ íƒí–ˆê³ , í‹€ë¦° ê²½ìš°ì—ë§Œ ì˜¤ë‹µ ì €ì¥ (ì±„ì  ê¸°ì¤€)
          const wrongAnswer: WrongAnswer = {
            questionId: q.id,
            question: q,
            userAnswer,
            timestamp: Date.now(),
            wrongCount: 1,
            correctStreak: 0,
          };
          console.log(`âŒ ì˜¤ë‹µ ì €ì¥ ì‹œë„: ë¬¸ì œ ${q.id} (${q.category}) - ì‚¬ìš©ì ë‹µë³€: ${userAnswer}, ì •ë‹µ: ${q.answer}`);
          addWrongAnswer(wrongAnswer);
          savedWrongCount++;
          console.log(`âœ… ì˜¤ë‹µ ì €ì¥ ì™„ë£Œ: ë¬¸ì œ ${q.id} (${q.category})`);
        }
      }
    });

    console.log(`ğŸ“Š ì±„ì í•˜ê¸° - ì˜¤ë‹µ ì €ì¥ ì™„ë£Œ: ${savedWrongCount}ê°œ ì˜¤ë‹µ ì €ì¥ë¨`);
    console.log(`ğŸ“Š ì±„ì í•˜ê¸° - ì €ì¥ëœ ì´ ì˜¤ë‹µ ìˆ˜: ${getWrongAnswers().length}`);

    // ì˜¤ë‹µë…¸íŠ¸ ëª¨ë“œì¼ ë•ŒëŠ” ì‘ì‹œí•œ ë¬¸ì œë§Œ ëŒ€ìƒìœ¼ë¡œ ì±„ì 
    let total: number;
    let score: number;
    let percentage: number;
    let encouragement: string = '';

    if (isWrongMode) {
      // ì˜¤ë‹µë…¸íŠ¸ ëª¨ë“œ: ì‘ì‹œí•œ ë¬¸ì œë§Œ ëŒ€ìƒìœ¼ë¡œ ì±„ì 
      total = answeredCount; // ì‘ì‹œí•œ ë¬¸ì œ ìˆ˜
      if (total === 0) {
        score = 0;
        percentage = 0;
        encouragement = 'ë‹µë³€ì„ ì„ íƒí•´ì£¼ì„¸ìš”! ğŸ’ª';
      } else {
        score = Math.round((correctCount / total) * 100);
        percentage = ((correctCount / total) * 100);
        
        // ê²©ë ¤ ë©”ì‹œì§€ ìƒì„±
        if (percentage === 100) {
          encouragement = 'ì•„ì£¼ ì˜í•˜ì˜€ì–´ìš”! ì™„ë²½í•©ë‹ˆë‹¤! ğŸ‰';
        } else if (percentage >= 80) {
          encouragement = 'í›Œë¥­í•©ë‹ˆë‹¤! ì˜í•˜ê³  ìˆì–´ìš”! ğŸ‘';
        } else if (percentage >= 60) {
          encouragement = 'ì¢‹ì•„ìš”! ê³„ì† ë…¸ë ¥í•˜ì„¸ìš”! ğŸ’ª';
        } else {
          encouragement = 'ì¡°ê¸ˆ ë” ë…¸ë ¥í•˜ë©´ ë” ì¢‹ì•„ì§ˆ ê±°ì˜ˆìš”! í™”ì´íŒ…! ğŸ’ª';
        }
      }
    } else {
      // ì¼ë°˜ ëª¨ë“œ: ì „ì²´ ë¬¸ì œ ëŒ€ìƒìœ¼ë¡œ ì±„ì 
      total = displayQuestions.length;
      score = Math.round((correctCount / total) * 100);
      percentage = ((correctCount / total) * 100);
    }

    // ì±„ì  ê²°ê³¼ ì €ì¥
    setScoreResult({
      total,
      correct: correctCount,
      wrong: wrongCount,
      unanswered: unansweredCount,
      score,
      percentage: parseFloat(percentage.toFixed(1)),
      encouragement: isWrongMode ? encouragement : undefined,
      answeredCount: isWrongMode ? answeredCount : undefined,
    });

    // ëª¨ë‹¬ í‘œì‹œ
    setShowScoreModal(true);
  };

  const answeredCount = Object.keys(answers).length;
  const currentQuestion = displayQuestions[currentIndex];
  const selectedAnswer = answers[currentQuestion?.id];

  const handlePrint = () => {
    setShowPrintOptions(true);
  };

  const handlePrintExecute = () => {
    setShowPrintOptions(false);
    setTimeout(() => {
      window.print();
    }, 100);
  };

  return (
    <>
      {/* Printable content */}
      <div className="printable hidden">
        <h1 className="text-2xl font-bold text-center mb-8">ì „ê¸°ê¸°ëŠ¥ì‚¬ CBT ë¬¸ì œ</h1>
        <div className="space-y-6">
          {displayQuestions.map((q, index) => (
            <div key={q.id} className="break-inside-avoid-page p-4 border-b">
              <div className="flex items-start mb-2">
                <h3 className="text-lg font-bold mr-4">{index + 1}.</h3>
                <LatexRenderer text={q.question} className="text-base" />
              </div>
              {q.imageUrl && (
                <div className="mb-2 pl-8">
                  <img src={q.imageUrl} alt={`ë¬¸ì œ ${index + 1} ì´ë¯¸ì§€`} className="max-w-xs rounded" />
                </div>
              )}
              <div className="space-y-2 pl-8">
                {[1, 2, 3, 4].map(optNum => {
                  const optionKey = `option${optNum}` as keyof Question;
                  const isCorrectAnswer = (printOption === 'withAnswers' || printOption === 'withExplanations') && q.answer === optNum;
                  return (
                    <div key={optNum} className="flex items-start">
                      <span className={`font-bold w-6 ${isCorrectAnswer ? 'text-blue-600' : ''}`}>
                        {optNum}.
                      </span>
                      <LatexRenderer text={q[optionKey] as string} className={`text-base ${isCorrectAnswer ? 'font-bold text-blue-600' : ''}`} />
                    </div>
                  );
                })}
              </div>
              {printOption === 'withAnswers' && (
                <div className="mt-2 pl-8 text-sm text-blue-600 font-bold">
                  ì •ë‹µ: {q.answer}ë²ˆ
                </div>
              )}
              {printOption === 'withExplanations' && (
                <>
                  <div className="mt-2 pl-8 text-sm text-blue-600 font-bold">
                    ì •ë‹µ: {q.answer}ë²ˆ
                  </div>
                  {q.explanation && (
                    <div className="mt-2 pl-8 p-2 bg-gray-50 rounded text-sm">
                      <span className="font-bold">í•´ì„¤:</span> {q.explanation}
                    </div>
                  )}
                </>
              )}
            </div>
          ))}
        </div>
      </div>

      {/* Non-printable exam UI */}
      <div className="min-h-screen bg-gray-100 p-3 non-printable">
        <div className="max-w-7xl mx-auto">
          {/* ìƒë‹¨ í—¤ë” */}
          <div className="bg-white rounded-lg shadow-md p-3 mb-2">
            <div className="flex justify-between items-center flex-wrap gap-3">
              <h1 className="text-xl font-bold text-gray-800">âš¡ ì „ê¸°ê¸°ëŠ¥ì‚¬ CBT</h1>
              <div className="flex items-center gap-2">
                {/* íƒ€ì´ë¨¸ */}
                <div
                  className={`px-4 py-2 rounded-lg font-bold text-lg ${remainingTime < 300
                      ? 'bg-red-100 text-red-700'
                      : 'bg-blue-100 text-blue-700'
                  }`}
                >
                  â±ï¸ {formatTime(remainingTime)}
                </div>
                <button
                  onClick={() => setShowFeedbackBoard(true)}
                  className="px-3 py-1.5 text-sm bg-orange-600 hover:bg-orange-700 text-white rounded-lg transition-colors"
                  title="ì œë³´ ê²Œì‹œíŒ"
                >
                  ğŸ“‹ ì œë³´
                </button>
                <button
                  onClick={() => setShowCalculator(true)}
                  className="px-3 py-1.5 text-sm bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg transition-colors"
                  title="ê³µí•™ìš© ê³„ì‚°ê¸°"
                >
                  ğŸ”¢ ê³„ì‚°ê¸°
                </button>
                <button
                  onClick={handlePrint}
                  className="px-3 py-1.5 text-sm bg-teal-600 hover:bg-teal-700 text-white rounded-lg transition-colors"
                >
                  ğŸ–¨ï¸ ì¸ì‡„
                </button>
                <button
                  onClick={handleSave}
                  className="px-3 py-1.5 text-sm bg-green-600 hover:bg-green-700 text-white rounded-lg transition-colors"
                >
                  ğŸ’¾ ì €ì¥í•˜ê¸°
                </button>
                <button
                  onClick={handleResetTime}
                  className="px-3 py-1.5 text-sm bg-purple-600 hover:bg-purple-700 text-white rounded-lg transition-colors"
                >
                  â° ì‹œê°„ ì´ˆê¸°í™”
                </button>
                <button
                  onClick={handleScore}
                  className="px-3 py-1.5 text-sm bg-yellow-600 hover:bg-yellow-700 text-white rounded-lg transition-colors"
                >
                  ğŸ“Š ì±„ì í•˜ê¸°
                </button>
                <button
                  onClick={handleExit}
                  className="px-3 py-1.5 text-sm bg-gray-500 hover:bg-gray-600 text-white rounded-lg transition-colors"
                >
                  â† ë‚˜ê°€ê¸°
                </button>
              </div>
            </div>
          </div>

          {/* ë¬¸ì œ í‘œì‹œ ì˜ì—­ */}
          <div className="bg-white rounded-lg shadow-md p-4 mb-2">
            <div className="flex justify-between items-center mb-4">
              <div className="text-sm text-gray-600">
                ë¬¸ì œ {currentIndex + 1} / {displayQuestions.length}
                {currentQuestion && currentQuestion.category && (
                  <span className="ml-2 px-2 py-1 bg-blue-100 text-blue-700 rounded text-xs font-medium">
                    {currentQuestion.category}
                  </span>
                )}
                {currentQuestion && currentQuestion.standard && (
                  <span className="ml-2 text-xs text-gray-500">
                    {currentQuestion.standard} - {getStandardTitle(currentQuestion.standard)}
                  </span>
                )}
              </div>
              <div className="text-sm font-medium text-gray-700">
                ë‹µë³€: {answeredCount} / {displayQuestions.length}
              </div>
            </div>

            {currentQuestion && (
              <>
                {/* ë¬¸ì œ */}
                <div className="mb-4 p-4 bg-gray-50 rounded-lg">
                  <div className="text-lg font-medium text-gray-900 leading-relaxed">
                    <LatexRenderer text={currentQuestion.question} />
                  </div>
                  {currentQuestion.imageUrl && (
                    <div className="mt-4">
                      <img
                        src={currentQuestion.imageUrl}
                        alt="ë¬¸ì œ ì´ë¯¸ì§€"
                        className="max-w-full h-auto rounded border border-gray-200"
                      />
                    </div>
                  )}
                  {currentQuestion.detailItem && (
                    <div className="mt-2 text-sm text-gray-600">
                      ì„¸ë¶€í•­ëª©: {currentQuestion.detailItem}
                    </div>
                  )}
                </div>

                {/* ì„ íƒì§€ */}
                <div className="space-y-2 mb-6">
                  {[1, 2, 3, 4].map((optNum) => {
                    const optionKey = `option${optNum}` as keyof Question;
                    const optionText = currentQuestion[optionKey] as string;

                    return (
                      <button
                        key={optNum}
                        onClick={() => handleAnswerSelect(optNum)}
                        className={`w-full text-left p-4 rounded-lg border-2 transition-all ${
                          selectedAnswer === optNum
                            ? 'border-blue-500 bg-blue-50'
                            : 'border-gray-200 hover:border-blue-300 hover:bg-gray-50'
                        }`}
                      >
                        <div className="flex items-start">
                          <span
                            className={`flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center font-bold mr-3 ${
                              selectedAnswer === optNum
                                ? 'bg-blue-500 text-white'
                                : 'bg-gray-200 text-gray-700'
                            }`}
                          >
                            {optNum}
                          </span>
                          <div className="flex-1 pt-1">
                            <LatexRenderer text={optionText} />
                          </div>
                        </div>
                      </button>
                    );
                  })}
                </div>

                {/* ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ */}
                <div className="flex justify-between items-center">
                  <button
                    onClick={handlePrevious}
                    disabled={currentIndex === 0}
                    className={`px-6 py-2 rounded-lg font-medium transition-colors ${
                      currentIndex === 0
                        ? 'bg-gray-200 text-gray-400 cursor-not-allowed'
                        : 'bg-gray-500 hover:bg-gray-600 text-white'
                    }`}
                  >
                    â† ì´ì „
                  </button>
                  <button
                    onClick={handleNext}
                    disabled={currentIndex === displayQuestions.length - 1}
                    className={`px-6 py-2 rounded-lg font-medium transition-colors ${
                      currentIndex === displayQuestions.length - 1
                        ? 'bg-gray-200 text-gray-400 cursor-not-allowed'
                        : 'bg-blue-500 hover:bg-blue-600 text-white'
                    }`}
                  >
                    ë‹¤ìŒ â†’
                  </button>
                </div>
              </>
            )}
          </div>

          {/* ë¬¸ì œ ë²ˆí˜¸ ê·¸ë¦¬ë“œ - ì¹´í…Œê³ ë¦¬ë³„ ê·¸ë£¹í™” */}
          <div className="bg-white rounded-lg shadow-md p-4">
            <div className="flex justify-between items-center mb-3">
              <h3 className="text-sm font-medium text-gray-700">ë¬¸ì œ ì„ íƒ</h3>
              <span className="text-xs text-gray-500">ğŸ’¡ ë¬¸ì œë²ˆí˜¸ë¥¼ í´ë¦­í•˜ì‹œë©´ ë¬¸ì œë¡œ ë°”ë¡œ ì´ë™í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</span>
            </div>

            {/* ì „ê¸°ì´ë¡  1-20 */}
            <div className="mb-4">
              <div className="text-xs font-semibold text-purple-700 mb-2 px-2 py-1 bg-purple-50 rounded inline-block">
                ì „ê¸°ì´ë¡  1-20
              </div>
              <div className="grid grid-cols-20 gap-1">
                {displayQuestions.slice(0, 20).map((q, index) => {
                  const isAnswered = !!answers[q.id];
                  const isCurrent = index === currentIndex;

                  return (
                    <button
                      key={q.id}
                      onClick={() => handleNavigate(index)}
                      className={`aspect-square rounded-full flex items-center justify-center text-xs font-medium transition-all ${
                        isCurrent
                          ? 'bg-purple-500 text-white ring-2 ring-purple-300'
                          : isAnswered
                          ? 'bg-purple-100 text-purple-700 hover:bg-purple-200'
                          : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
                      }`}
                    >
                      {index + 1}
                    </button>
                  );
                })}
              </div>
            </div>

            {/* ì „ê¸°ê¸°ê¸° 21-40 */}
            <div className="mb-4">
              <div className="text-xs font-semibold text-blue-700 mb-2 px-2 py-1 bg-blue-50 rounded inline-block">
                ì „ê¸°ê¸°ê¸° 21-40
              </div>
              <div className="grid grid-cols-20 gap-1">
                {displayQuestions.slice(20, 40).map((q, index) => {
                  const actualIndex = index + 20;
                  const isAnswered = !!answers[q.id];
                  const isCurrent = actualIndex === currentIndex;

                  return (
                    <button
                      key={q.id}
                      onClick={() => handleNavigate(actualIndex)}
                      className={`aspect-square rounded-full flex items-center justify-center text-xs font-medium transition-all ${
                        isCurrent
                          ? 'bg-blue-500 text-white ring-2 ring-blue-300'
                          : isAnswered
                          ? 'bg-blue-100 text-blue-700 hover:bg-blue-200'
                          : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
                      }`}
                    >
                      {actualIndex + 1}
                    </button>
                  );
                })}
              </div>
            </div>

            {/* ì „ê¸°ì„¤ë¹„ 41-60 */}
            <div>
              <div className="text-xs font-semibold text-green-700 mb-2 px-2 py-1 bg-green-50 rounded inline-block">
                ì „ê¸°ì„¤ë¹„ 41-60
              </div>
              <div className="grid grid-cols-20 gap-1">
                {displayQuestions.slice(40, 60).map((q, index) => {
                  const actualIndex = index + 40;
                  const isAnswered = !!answers[q.id];
                  const isCurrent = actualIndex === currentIndex;

                  return (
                    <button
                      key={q.id}
                      onClick={() => handleNavigate(actualIndex)}
                      className={`aspect-square rounded-full flex items-center justify-center text-xs font-medium transition-all ${
                        isCurrent
                          ? 'bg-green-500 text-white ring-2 ring-green-300'
                          : isAnswered
                          ? 'bg-green-100 text-green-700 hover:bg-green-200'
                          : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
                      }`}
                    >
                      {actualIndex + 1}
                    </button>
                  );
                })}
              </div>
            </div>
          </div>
        </div>
      </div>

      {/* ì¸ì‡„ ì˜µì…˜ ì„ íƒ ëª¨ë‹¬ */}
      {showPrintOptions && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 non-printable">
          <div className="bg-white rounded-2xl shadow-2xl max-w-md w-full p-6">
            <h2 className="text-2xl font-bold text-gray-800 mb-4">ğŸ–¨ï¸ ì¸ì‡„ ì˜µì…˜ ì„ íƒ</h2>
            <p className="text-sm text-gray-600 mb-6">ì¸ì‡„í•  ë‚´ìš©ì„ ì„ íƒí•˜ì„¸ìš”</p>

            <div className="space-y-3 mb-6">
              {/* ë¬¸ì œë§Œ ì¸ì‡„ */}
              <button
                onClick={() => setPrintOption('questionsOnly')}
                className={`w-full text-left p-4 rounded-lg border-2 transition-all ${
                  printOption === 'questionsOnly'
                    ? 'border-blue-500 bg-blue-50'
                    : 'border-gray-200 hover:border-blue-300'
                }`}
              >
                <div className="flex items-center">
                  <div
                    className={`w-5 h-5 rounded-full border-2 mr-3 flex items-center justify-center ${
                      printOption === 'questionsOnly'
                        ? 'border-blue-500 bg-blue-500'
                        : 'border-gray-300'
                    }`}
                  >
                    {printOption === 'questionsOnly' && (
                      <div className="w-2 h-2 bg-white rounded-full"></div>
                    )}
                  </div>
                  <div>
                    <div className="font-bold text-gray-800">ğŸ“ ë¬¸ì œë§Œ ì¸ì‡„</div>
                    <div className="text-sm text-gray-600">ë¬¸ì œì™€ ì„ íƒì§€ë§Œ ì¸ì‡„ (ì •ë‹µ í‘œì‹œ ì—†ìŒ)</div>
                  </div>
                </div>
              </button>

              {/* ì •ë‹µ í‘œì‹œ ì¸ì‡„ */}
              <button
                onClick={() => setPrintOption('withAnswers')}
                className={`w-full text-left p-4 rounded-lg border-2 transition-all ${
                  printOption === 'withAnswers'
                    ? 'border-blue-500 bg-blue-50'
                    : 'border-gray-200 hover:border-blue-300'
                }`}
              >
                <div className="flex items-center">
                  <div
                    className={`w-5 h-5 rounded-full border-2 mr-3 flex items-center justify-center ${
                      printOption === 'withAnswers'
                        ? 'border-blue-500 bg-blue-500'
                        : 'border-gray-300'
                    }`}
                  >
                    {printOption === 'withAnswers' && (
                      <div className="w-2 h-2 bg-white rounded-full"></div>
                    )}
                  </div>
                  <div>
                    <div className="font-bold text-gray-800">âœ… ì •ë‹µ í‘œì‹œ ì¸ì‡„</div>
                    <div className="text-sm text-gray-600">ë¬¸ì œ + ì •ë‹µ í‘œì‹œ (íŒŒë€ìƒ‰ âœ“ í‘œì‹œ)</div>
                  </div>
                </div>
              </button>

              {/* ì •ë‹µ + í•´ì„¤ ì¸ì‡„ */}
              <button
                onClick={() => setPrintOption('withExplanations')}
                className={`w-full text-left p-4 rounded-lg border-2 transition-all ${
                  printOption === 'withExplanations'
                    ? 'border-blue-500 bg-blue-50'
                    : 'border-gray-200 hover:border-blue-300'
                }`}
              >
                <div className="flex items-center">
                  <div
                    className={`w-5 h-5 rounded-full border-2 mr-3 flex items-center justify-center ${
                      printOption === 'withExplanations'
                        ? 'border-blue-500 bg-blue-500'
                        : 'border-gray-300'
                    }`}
                  >
                    {printOption === 'withExplanations' && (
                      <div className="w-2 h-2 bg-white rounded-full"></div>
                    )}
                  </div>
                  <div>
                    <div className="font-bold text-gray-800">ğŸ“š ì •ë‹µ + í•´ì„¤ ì¸ì‡„</div>
                    <div className="text-sm text-gray-600">ë¬¸ì œ + ì •ë‹µ + í•´ì„¤ ì „ì²´</div>
                  </div>
                </div>
              </button>
            </div>

            <div className="flex gap-3">
              <button
                onClick={() => setShowPrintOptions(false)}
                className="flex-1 px-6 py-3 bg-gray-500 hover:bg-gray-600 text-white rounded-lg font-medium transition-colors"
              >
                ì·¨ì†Œ
              </button>
              <button
                onClick={handlePrintExecute}
                className="flex-1 px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-colors"
              >
                ì¸ì‡„í•˜ê¸°
              </button>
            </div>
          </div>
        </div>
      )}
    </>
  );
}
