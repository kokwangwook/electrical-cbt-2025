<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JSON â†’ Supabase ë°ì´í„° ì´ì „</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 50px auto;
            padding: 20px;
        }
        .section {
            margin: 30px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .result {
            margin: 15px 0;
            padding: 15px;
            border-radius: 5px;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        button {
            padding: 12px 24px;
            font-size: 16px;
            cursor: pointer;
            margin: 5px;
            border: none;
            border-radius: 5px;
        }
        .btn-primary {
            background-color: #007bff;
            color: white;
        }
        .btn-primary:hover {
            background-color: #0056b3;
        }
        .btn-danger {
            background-color: #dc3545;
            color: white;
        }
        .btn-danger:hover {
            background-color: #c82333;
        }
        input[type="file"] {
            margin: 10px 0;
            padding: 10px;
        }
        .progress {
            margin: 10px 0;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 5px;
        }
        pre {
            background-color: #f4f4f4;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
            max-height: 300px;
            overflow-y: auto;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }
        .stat-box {
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 5px;
            text-align: center;
        }
        .stat-box strong {
            display: block;
            font-size: 24px;
            color: #007bff;
        }
    </style>
</head>
<body>
    <h1>ğŸ“„ JSON íŒŒì¼ â†’ Supabase ë°ì´í„° ì´ì „</h1>
    
    <div class="section">
        <h2>1ë‹¨ê³„: JSON íŒŒì¼ ì„ íƒ</h2>
        <p>ê´€ë¦¬ì í˜ì´ì§€ì—ì„œ ë‚´ë³´ë‚¸ <code>electrical-cbt-backup-*.json</code> íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”.</p>
        <input type="file" id="jsonFile" accept=".json" />
        <button class="btn-primary" onclick="loadJSON()">JSON íŒŒì¼ ë¡œë“œ</button>
        <div id="loadResult"></div>
    </div>

    <div class="section">
        <h2>2ë‹¨ê³„: ë°ì´í„° ë¯¸ë¦¬ë³´ê¸°</h2>
        <div id="previewResult"></div>
    </div>

    <div class="section">
        <h2>3ë‹¨ê³„: Supabase í…Œì´ë¸”ì— ì»¬ëŸ¼ ì¶”ê°€ (í•„ìˆ˜)</h2>
        <div class="result info">
            <p><strong>ğŸ“‹ ë¨¼ì € Supabaseì— ì»¬ëŸ¼ì„ ì¶”ê°€í•´ì•¼ í•©ë‹ˆë‹¤:</strong></p>
            <ol style="margin: 10px 0; padding-left: 20px;">
                <li>Supabase ëŒ€ì‹œë³´ë“œ â†’ SQL Editor ì—´ê¸°</li>
                <li>ì•„ë˜ SQLì„ ë³µì‚¬í•´ì„œ ë¶™ì—¬ë„£ê¸°</li>
                <li>"Run" ë²„íŠ¼ í´ë¦­</li>
            </ol>
            <div style="margin: 15px 0;">
                <button class="btn-primary" onclick="copySQL()" style="margin-bottom: 10px;">ğŸ“‹ SQL ë³µì‚¬í•˜ê¸°</button>
                <pre id="sqlCode" style="background-color: #f4f4f4; padding: 15px; border-radius: 5px; overflow-x: auto; cursor: pointer; user-select: all;" onclick="selectSQL()">-- ============================================
-- Supabase í…Œì´ë¸” ì„¤ì • SQL
-- ============================================
-- ì´ SQLì„ Supabase SQL Editorì—ì„œ í•œ ë²ˆì— ì‹¤í–‰í•˜ì„¸ìš”.
-- ê¸°ì¡´ ì •ì±…ì´ ìˆì–´ë„ ì˜¤ë¥˜ ì—†ì´ ì‹¤í–‰ë©ë‹ˆë‹¤.
-- ============================================

-- ============================================
-- 1. RLS (Row Level Security) í™œì„±í™” ë° ì •ì±… ìƒì„±
-- ============================================

-- questions í…Œì´ë¸”: ëª¨ë“  ì‚¬ìš©ì ì½ê¸° ê°€ëŠ¥
ALTER TABLE questions ENABLE ROW LEVEL SECURITY;
DROP POLICY IF EXISTS "ëª¨ë“  ì‚¬ìš©ì ì½ê¸° ê°€ëŠ¥" ON questions;
CREATE POLICY "ëª¨ë“  ì‚¬ìš©ì ì½ê¸° ê°€ëŠ¥" ON questions
FOR SELECT TO public USING (true);

-- members í…Œì´ë¸”: ìì‹ ì˜ í”„ë¡œí•„ë§Œ ì ‘ê·¼
ALTER TABLE members ENABLE ROW LEVEL SECURITY;
DROP POLICY IF EXISTS "ìì‹ ì˜ í”„ë¡œí•„ ë³´ê¸°" ON members;
DROP POLICY IF EXISTS "ìì‹ ì˜ í”„ë¡œí•„ ìˆ˜ì •" ON members;
CREATE POLICY "ìì‹ ì˜ í”„ë¡œí•„ ë³´ê¸°" ON members
FOR SELECT TO authenticated USING (auth.uid()::text = id);
CREATE POLICY "ìì‹ ì˜ í”„ë¡œí•„ ìˆ˜ì •" ON members
FOR UPDATE TO authenticated USING (auth.uid()::text = id);

-- exam_results í…Œì´ë¸”: ìì‹ ì˜ ê²°ê³¼ë§Œ ì ‘ê·¼
ALTER TABLE exam_results ENABLE ROW LEVEL SECURITY;
DROP POLICY IF EXISTS "ìì‹ ì˜ ê²°ê³¼ ë³´ê¸°" ON exam_results;
DROP POLICY IF EXISTS "ìì‹ ì˜ ê²°ê³¼ ì €ì¥" ON exam_results;
CREATE POLICY "ìì‹ ì˜ ê²°ê³¼ ë³´ê¸°" ON exam_results
FOR SELECT TO authenticated USING (auth.uid()::text = user_id);
CREATE POLICY "ìì‹ ì˜ ê²°ê³¼ ì €ì¥" ON exam_results
FOR INSERT TO authenticated WITH CHECK (auth.uid()::text = user_id);

-- wrong_answers í…Œì´ë¸”: ìì‹ ì˜ ì˜¤ë‹µë§Œ ì ‘ê·¼
ALTER TABLE wrong_answers ENABLE ROW LEVEL SECURITY;
DROP POLICY IF EXISTS "ìì‹ ì˜ ì˜¤ë‹µ ë³´ê¸°" ON wrong_answers;
DROP POLICY IF EXISTS "ìì‹ ì˜ ì˜¤ë‹µ ì €ì¥" ON wrong_answers;
DROP POLICY IF EXISTS "ìì‹ ì˜ ì˜¤ë‹µ ìˆ˜ì •" ON wrong_answers;
CREATE POLICY "ìì‹ ì˜ ì˜¤ë‹µ ë³´ê¸°" ON wrong_answers
FOR SELECT TO authenticated USING (auth.uid()::text = user_id);
CREATE POLICY "ìì‹ ì˜ ì˜¤ë‹µ ì €ì¥" ON wrong_answers
FOR INSERT TO authenticated WITH CHECK (auth.uid()::text = user_id);
CREATE POLICY "ìì‹ ì˜ ì˜¤ë‹µ ìˆ˜ì •" ON wrong_answers
FOR UPDATE TO authenticated USING (auth.uid()::text = user_id);

-- ============================================
-- 2. questions í…Œì´ë¸”ì— ì»¬ëŸ¼ ì¶”ê°€
-- ============================================

-- detailItem ì»¬ëŸ¼ ì¶”ê°€ (ì„¸ë¶€í•­ëª©)
ALTER TABLE questions ADD COLUMN IF NOT EXISTS "detailItem" TEXT;

-- source ì»¬ëŸ¼ ì¶”ê°€ (ë¬¸ì œ ì¶œì²˜)
ALTER TABLE questions ADD COLUMN IF NOT EXISTS "source" TEXT;

-- ============================================
-- ì‹¤í–‰ ì™„ë£Œ!
-- ============================================</pre>
            </div>
        </div>
    </div>

    <div class="section">
        <h2>4ë‹¨ê³„: Supabaseë¡œ ë°ì´í„° ì´ì „</h2>
        <div class="result warning">
            <p><strong>âš ï¸ ì£¼ì˜:</strong> ì´ ì‘ì—…ì€ ê¸°ì¡´ Supabaseì˜ questions í…Œì´ë¸” ë°ì´í„°ë¥¼ ì‚­ì œí•˜ê³  ìƒˆë¡œ ì¶”ê°€í•©ë‹ˆë‹¤.</p>
            <p>ê¸°ì¡´ ë°ì´í„°ë¥¼ ë°±ì—…í•˜ë ¤ë©´ ë¨¼ì € "Supabase ë°ì´í„° í™•ì¸" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.</p>
        </div>
        <button class="btn-danger" onclick="migrateToSupabase()">Supabaseë¡œ ì´ì „ ì‹œì‘</button>
        <div id="migrateResult"></div>
    </div>

    <div class="section">
        <h2>5ë‹¨ê³„: ì´ì „ ê²°ê³¼ í™•ì¸</h2>
        <button class="btn-primary" onclick="verifyMigration()">Supabase ë°ì´í„° í™•ì¸</button>
        <div id="verifyResult"></div>
    </div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

        const supabaseUrl = 'https://eeyzenpolbrfmsamguvf.supabase.co';
        const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVleXplbnBvbGJyZm1zYW1ndXZmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMxNDg4NjcsImV4cCI6MjA3ODcyNDg2N30.cRxc6STLnhDI2Fm7jADLhhdko50esBNuYOkha3BC0-0';
        const supabase = createClient(supabaseUrl, supabaseAnonKey);

        let loadedQuestions = [];
        let loadedData = null;

        // SQL ë³µì‚¬ í•¨ìˆ˜
        window.copySQL = async function() {
            const sqlCode = document.getElementById('sqlCode').textContent;
            try {
                await navigator.clipboard.writeText(sqlCode);
                alert('âœ… SQLì´ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!\n\nì´ì œ Supabase SQL Editorì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.');
            } catch (err) {
                // í´ë¦½ë³´ë“œ API ì‹¤íŒ¨ ì‹œ ìˆ˜ë™ ì„ íƒ
                const textArea = document.createElement('textarea');
                textArea.value = sqlCode;
                textArea.style.position = 'fixed';
                textArea.style.opacity = '0';
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    alert('âœ… SQLì´ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!\n\nì´ì œ Supabase SQL Editorì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.');
                } catch (err2) {
                    alert('âŒ ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. SQLì„ ì§ì ‘ ì„ íƒí•´ì„œ ë³µì‚¬í•˜ì„¸ìš”.');
                }
                document.body.removeChild(textArea);
            }
        };

        // SQL ì„ íƒ í•¨ìˆ˜
        window.selectSQL = function() {
            const sqlCode = document.getElementById('sqlCode');
            const range = document.createRange();
            range.selectNodeContents(sqlCode);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
        };

        // 1ë‹¨ê³„: JSON íŒŒì¼ ë¡œë“œ
        window.loadJSON = function() {
            const fileInput = document.getElementById('jsonFile');
            const file = fileInput.files[0];
            
            if (!file) {
                document.getElementById('loadResult').innerHTML = 
                    '<div class="result error"><p>íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.</p></div>';
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const jsonText = e.target.result;
                    loadedData = JSON.parse(jsonText);
                    
                    console.log('ë¡œë“œëœ JSON êµ¬ì¡°:', Object.keys(loadedData));
                    
                    // questions ë°°ì—´ ì¶”ì¶œ
                    if (!loadedData.questions || !Array.isArray(loadedData.questions)) {
                        throw new Error('JSON íŒŒì¼ì— questions ë°°ì—´ì´ ì—†ìŠµë‹ˆë‹¤.');
                    }
                    
                    loadedQuestions = loadedData.questions;
                    
                    if (loadedQuestions.length === 0) {
                        document.getElementById('loadResult').innerHTML = `
                            <div class="result error">
                                <h3>âš ï¸ ë¬¸ì œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</h3>
                                <p>JSON íŒŒì¼ì— questions ë°°ì—´ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.</p>
                            </div>
                        `;
                        document.getElementById('previewResult').innerHTML = '';
                        return;
                    }
                    
                    // í†µê³„ ê³„ì‚°
                    const categoryStats = {};
                    let withImage = 0;
                    let withStandard = 0;
                    
                    loadedQuestions.forEach(q => {
                        categoryStats[q.category] = (categoryStats[q.category] || 0) + 1;
                        if (q.hasImage || q.imageUrl) withImage++;
                        if (q.standard) withStandard++;
                    });
                    
                    document.getElementById('loadResult').innerHTML = `
                        <div class="result success">
                            <h3>âœ… JSON íŒŒì¼ ë¡œë“œ ì™„ë£Œ!</h3>
                            <div class="stats">
                                <div class="stat-box">
                                    <strong>${loadedQuestions.length}</strong>
                                    <div>ì „ì²´ ë¬¸ì œ</div>
                                </div>
                                <div class="stat-box">
                                    <strong>${withImage}</strong>
                                    <div>ì´ë¯¸ì§€ í¬í•¨</div>
                                </div>
                                <div class="stat-box">
                                    <strong>${withStandard}</strong>
                                    <div>ì¶œì œê¸°ì¤€ í¬í•¨</div>
                                </div>
                            </div>
                            <h4>ì¹´í…Œê³ ë¦¬ë³„ í†µê³„:</h4>
                            <ul>
                                ${Object.entries(categoryStats).map(([cat, count]) => 
                                    `<li><strong>${cat}:</strong> ${count}ê°œ</li>`
                                ).join('')}
                            </ul>
                        </div>
                    `;

                    // ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ
                    const sample1 = loadedQuestions[0];
                    const sample2 = loadedQuestions.length > 1 ? loadedQuestions[1] : null;
                    
                    document.getElementById('previewResult').innerHTML = `
                        <div class="result info">
                            <h3>ğŸ“‹ ë°ì´í„° ë¯¸ë¦¬ë³´ê¸°</h3>
                            <p><strong>ì²« ë²ˆì§¸ ë¬¸ì œ (ID: ${sample1.id}):</strong></p>
                            <pre>${JSON.stringify({
                                id: sample1.id,
                                category: sample1.category,
                                question: sample1.question.substring(0, 100) + '...',
                                option1: sample1.option1.substring(0, 50) + '...',
                                answer: sample1.answer,
                                hasImage: sample1.hasImage || !!sample1.imageUrl,
                                standard: sample1.standard || 'ì—†ìŒ',
                                detailItem: sample1.detailItem || 'ì—†ìŒ',
                                weight: sample1.weight || 5
                            }, null, 2)}</pre>
                            ${sample2 ? `
                                <p><strong>ë‘ ë²ˆì§¸ ë¬¸ì œ (ID: ${sample2.id}):</strong></p>
                                <pre>${JSON.stringify({
                                    id: sample2.id,
                                    category: sample2.category,
                                    question: sample2.question.substring(0, 100) + '...',
                                    option1: sample2.option1.substring(0, 50) + '...',
                                    answer: sample2.answer,
                                    hasImage: sample2.hasImage || !!sample2.imageUrl,
                                    standard: sample2.standard || 'ì—†ìŒ',
                                    detailItem: sample2.detailItem || 'ì—†ìŒ',
                                    weight: sample2.weight || 5
                                }, null, 2)}</pre>
                            ` : ''}
                        </div>
                    `;
                } catch (error) {
                    console.error('JSON íŒŒì‹± ì˜¤ë¥˜:', error);
                    document.getElementById('loadResult').innerHTML = `
                        <div class="result error">
                            <h3>âŒ íŒŒì¼ íŒŒì‹± ì‹¤íŒ¨</h3>
                            <p>${error.message}</p>
                            <p>JSON íŒŒì¼ í˜•ì‹ì„ í™•ì¸í•´ì£¼ì„¸ìš”. ë¸Œë¼ìš°ì € ì½˜ì†”(F12)ì—ì„œ ìì„¸í•œ ì˜¤ë¥˜ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                        </div>
                    `;
                    document.getElementById('previewResult').innerHTML = '';
                }
            };
            reader.onerror = function() {
                document.getElementById('loadResult').innerHTML = 
                    '<div class="result error"><p>íŒŒì¼ ì½ê¸° ì‹¤íŒ¨</p></div>';
            };
            reader.readAsText(file, 'UTF-8');
        };

        // 3ë‹¨ê³„: Supabaseë¡œ ì´ì „
        window.migrateToSupabase = async function() {
            const resultDiv = document.getElementById('migrateResult');
            
            if (loadedQuestions.length === 0) {
                resultDiv.innerHTML = '<div class="result error"><p>ë¨¼ì € JSON íŒŒì¼ì„ ë¡œë“œí•´ì£¼ì„¸ìš”.</p></div>';
                return;
            }

            if (!confirm(`ì •ë§ë¡œ Supabaseì˜ questions í…Œì´ë¸”ì— ${loadedQuestions.length}ê°œ ë¬¸ì œë¥¼ ì´ì „í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nê¸°ì¡´ ë°ì´í„°ëŠ” ëª¨ë‘ ì‚­ì œë©ë‹ˆë‹¤.`)) {
                return;
            }

            resultDiv.innerHTML = '<div class="progress"><p>ì´ì „ ì¤€ë¹„ ì¤‘...</p></div>';

            try {
                // ê¸°ì¡´ ë°ì´í„° ì‚­ì œ
                resultDiv.innerHTML = '<div class="progress"><p>ê¸°ì¡´ ë°ì´í„° ì‚­ì œ ì¤‘...</p></div>';
                const { error: deleteError } = await supabase
                    .from('questions')
                    .delete()
                    .neq('id', 0);

                if (deleteError && deleteError.code !== 'PGRST116') {
                    console.warn('ê¸°ì¡´ ë°ì´í„° ì‚­ì œ ê²½ê³ :', deleteError);
                    // PGRST116ì€ "no rows found" ì˜¤ë¥˜ì´ë¯€ë¡œ ë¬´ì‹œ ê°€ëŠ¥
                }

                // ë°ì´í„° ì •ì œ ë° ë³€í™˜
                const cleanedQuestions = loadedQuestions.map(q => {
                    // íƒ€ì… ì•ˆì „í•˜ê²Œ ë³€í™˜
                    const answer = typeof q.answer === 'number' ? q.answer : parseInt(q.answer) || 1;
                    const weight = typeof q.weight === 'number' ? q.weight : parseInt(q.weight) || 5;
                    
                    // boolean íƒ€ì… í™•ì‹¤í•˜ê²Œ ë³€í™˜
                    const hasImage = q.hasImage === true || q.hasImage === 'true' || !!(q.imageUrl && String(q.imageUrl).trim());
                    const mustInclude = q.mustInclude === true || q.mustInclude === 'true' || false;
                    const mustExclude = q.mustExclude === true || q.mustExclude === 'true' || false;
                    
                    // null/undefined ì²˜ë¦¬
                    const imageUrl = (q.imageUrl && String(q.imageUrl).trim()) || null;
                    const standard = (q.standard && String(q.standard).trim()) || null;
                    const detailItem = (q.detailItem && String(q.detailItem).trim()) || null;
                    
                    // Supabase í…Œì´ë¸”ì— ìˆëŠ” ì»¬ëŸ¼ë§Œ í¬í•¨
                    const questionData = {
                        id: Number(q.id),
                        category: String(q.category || 'ê¸°íƒ€'),
                        question: String(q.question || ''),
                        option1: String(q.option1 || ''),
                        option2: String(q.option2 || ''),
                        option3: String(q.option3 || ''),
                        option4: String(q.option4 || ''),
                        answer: Math.max(1, Math.min(4, answer)), // 1-4 ë²”ìœ„ë¡œ ì œí•œ
                        explanation: String(q.explanation || ''),
                        imageUrl: imageUrl,
                        hasImage: Boolean(hasImage),
                        weight: Math.max(1, Math.min(10, weight)), // 1-10 ë²”ìœ„ë¡œ ì œí•œ
                        mustInclude: Boolean(mustInclude),
                        mustExclude: Boolean(mustExclude)
                    };
                    
                    // standardì™€ detailItem ì¶”ê°€
                    if (standard) questionData.standard = standard;
                    if (detailItem) questionData.detailItem = detailItem;
                    
                    return questionData;
                }).filter(q => {
                    // í•„ìˆ˜ í•„ë“œ ê²€ì¦
                    return q.id > 0 && 
                           q.question.length > 0 && 
                           q.option1.length > 0 && 
                           q.option2.length > 0 && 
                           q.option3.length > 0 && 
                           q.option4.length > 0 &&
                           q.answer >= 1 && q.answer <= 4;
                });

                // í…ŒìŠ¤íŠ¸: ì²« ë²ˆì§¸ ë¬¸ì œë§Œ ì‚½ì…í•´ì„œ ì˜¤ë¥˜ í™•ì¸
                if (cleanedQuestions.length > 0) {
                    resultDiv.innerHTML = '<div class="progress"><p>í…ŒìŠ¤íŠ¸ ì¤‘... (ì²« ë²ˆì§¸ ë¬¸ì œë§Œ ì‚½ì…)</p></div>';
                    const testQuestion = cleanedQuestions[0];
                    const { data: testData, error: testError } = await supabase
                        .from('questions')
                        .insert([testQuestion]);
                    
                    if (testError) {
                        resultDiv.innerHTML = `
                            <div class="result error">
                                <h3>âŒ í…ŒìŠ¤íŠ¸ ì‚½ì… ì‹¤íŒ¨</h3>
                                <p><strong>ì˜¤ë¥˜ ë©”ì‹œì§€:</strong> ${testError.message}</p>
                                <p><strong>ì˜¤ë¥˜ ì½”ë“œ:</strong> ${testError.code || 'N/A'}</p>
                                <p><strong>ì˜¤ë¥˜ ìƒì„¸:</strong></p>
                                <pre>${JSON.stringify(testError, null, 2)}</pre>
                                <p><strong>í…ŒìŠ¤íŠ¸ ë¬¸ì œ ë°ì´í„°:</strong></p>
                                <pre>${JSON.stringify(testQuestion, null, 2)}</pre>
                            </div>
                        `;
                        return;
                    } else {
                        // í…ŒìŠ¤íŠ¸ ì„±ê³µ ì‹œ ì‚½ì…í•œ ë°ì´í„° ì‚­ì œ
                        await supabase.from('questions').delete().eq('id', testQuestion.id);
                        resultDiv.innerHTML = '<div class="progress"><p>í…ŒìŠ¤íŠ¸ ì„±ê³µ! ì „ì²´ ë°ì´í„° ì´ì „ ì‹œì‘...</p></div>';
                    }
                }

                // ë°ì´í„° ì´ì „ (ë°°ì¹˜ë¡œ ë‚˜ëˆ ì„œ)
                const batchSize = 100;
                let successCount = 0;
                let errorCount = 0;
                const errors = [];

                for (let i = 0; i < cleanedQuestions.length; i += batchSize) {
                    const batch = cleanedQuestions.slice(i, i + batchSize);
                    
                    const { data, error } = await supabase
                        .from('questions')
                        .insert(batch);

                    if (error) {
                        console.error(`ë°°ì¹˜ ${Math.floor(i / batchSize) + 1} ì˜¤ë¥˜:`, error);
                        console.error('ì˜¤ë¥˜ ìƒì„¸:', JSON.stringify(error, null, 2));
                        console.error('ë°°ì¹˜ ìƒ˜í”Œ (ì²« ë²ˆì§¸ ë¬¸ì œ):', JSON.stringify(batch[0], null, 2));
                        
                        errorCount += batch.length;
                        const errorDetails = error.details || error.message || JSON.stringify(error);
                        errors.push(`ë°°ì¹˜ ${Math.floor(i / batchSize) + 1} (ë¬¸ì œ ${i + 1}~${Math.min(i + batchSize, cleanedQuestions.length)}): ${errorDetails}`);
                    } else {
                        successCount += batch.length;
                    }

                    // ì§„í–‰ ìƒí™© ì—…ë°ì´íŠ¸
                    const progress = Math.round(((i + batch.length) / cleanedQuestions.length) * 100);
                    resultDiv.innerHTML = `
                        <div class="progress">
                            <p><strong>ì§„í–‰ ì¤‘...</strong> ${Math.min(i + batch.length, cleanedQuestions.length)} / ${cleanedQuestions.length} (${progress}%)</p>
                            <p>ì„±ê³µ: ${successCount}ê°œ | ì‹¤íŒ¨: ${errorCount}ê°œ</p>
                        </div>
                    `;
                }

                let html = `
                    <div class="result success">
                        <h3>âœ… ë°ì´í„° ì´ì „ ì™„ë£Œ!</h3>
                        <div class="stats">
                            <div class="stat-box">
                                <strong>${successCount}</strong>
                                <div>ì„±ê³µ</div>
                            </div>
                            <div class="stat-box">
                                <strong>${errorCount}</strong>
                                <div>ì‹¤íŒ¨</div>
                            </div>
                            <div class="stat-box">
                                <strong>${cleanedQuestions.length}</strong>
                                <div>ì „ì²´</div>
                            </div>
                        </div>
                    </div>
                `;

                if (errors.length > 0) {
                    html += `
                        <div class="result error">
                            <h4>âš ï¸ ì˜¤ë¥˜ ìƒì„¸ (ìµœëŒ€ 10ê°œ):</h4>
                            <pre>${errors.slice(0, 10).join('\n')}</pre>
                            ${errors.length > 10 ? `<p>... ì™¸ ${errors.length - 10}ê°œ ì˜¤ë¥˜</p>` : ''}
                        </div>
                    `;
                }

                resultDiv.innerHTML = html;
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="result error">
                        <h3>âŒ ì´ì „ ì‹¤íŒ¨</h3>
                        <p>ì˜¤ë¥˜: ${error.message}</p>
                        <p>ë¸Œë¼ìš°ì € ì½˜ì†”(F12)ì—ì„œ ìì„¸í•œ ì˜¤ë¥˜ë¥¼ í™•ì¸í•˜ì„¸ìš”.</p>
                    </div>
                `;
                console.error('ì´ì „ ì˜¤ë¥˜:', error);
            }
        };

        // 4ë‹¨ê³„: ì´ì „ ê²°ê³¼ í™•ì¸
        window.verifyMigration = async function() {
            const resultDiv = document.getElementById('verifyResult');
            resultDiv.innerHTML = '<div class="progress"><p>í™•ì¸ ì¤‘...</p></div>';

            try {
                // ì „ì²´ ê°œìˆ˜ í™•ì¸
                const { count, error: countError } = await supabase
                    .from('questions')
                    .select('*', { count: 'exact', head: true });

                if (countError) throw countError;

                // ìƒ˜í”Œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                const { data: questions, error: dataError } = await supabase
                    .from('questions')
                    .select('*')
                    .limit(5)
                    .order('id', { ascending: true });

                if (dataError) throw dataError;

                // ì¹´í…Œê³ ë¦¬ë³„ í†µê³„
                const { data: categoryData, error: categoryError } = await supabase
                    .from('questions')
                    .select('category');

                let categoryStats = {};
                if (!categoryError && categoryData) {
                    categoryData.forEach(q => {
                        categoryStats[q.category] = (categoryStats[q.category] || 0) + 1;
                    });
                }

                let html = '<div class="result success">';
                html += '<h3>âœ… Supabase ë°ì´í„° í™•ì¸</h3>';
                html += `<div class="stats">`;
                html += `<div class="stat-box"><strong>${count || 0}</strong><div>ì „ì²´ ë¬¸ì œ</div></div>`;
                Object.entries(categoryStats).forEach(([cat, cnt]) => {
                    html += `<div class="stat-box"><strong>${cnt}</strong><div>${cat}</div></div>`;
                });
                html += `</div>`;
                html += '</div>';

                if (questions && questions.length > 0) {
                    html += '<div class="result info">';
                    html += '<h4>ìƒ˜í”Œ ë°ì´í„° (ìµœëŒ€ 5ê°œ):</h4>';
                    html += `<pre>${JSON.stringify(questions.map(q => ({
                        id: q.id,
                        category: q.category,
                        question: q.question.substring(0, 80) + '...',
                        answer: q.answer,
                        hasImage: q.hasImage,
                        standard: q.standard || 'ì—†ìŒ'
                    })), null, 2)}</pre>`;
                    html += '</div>';
                }

                resultDiv.innerHTML = html;
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="result error">
                        <h3>âŒ í™•ì¸ ì‹¤íŒ¨</h3>
                        <p>ì˜¤ë¥˜: ${error.message}</p>
                        <p>ë¸Œë¼ìš°ì € ì½˜ì†”(F12)ì—ì„œ ìì„¸í•œ ì˜¤ë¥˜ë¥¼ í™•ì¸í•˜ì„¸ìš”.</p>
                    </div>
                `;
                console.error('í™•ì¸ ì˜¤ë¥˜:', error);
            }
        };
    </script>
</body>
</html>

