<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TSV â†’ Supabase ë°ì´í„° ì´ì „</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 50px auto;
            padding: 20px;
        }
        .section {
            margin: 30px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .result {
            margin: 15px 0;
            padding: 15px;
            border-radius: 5px;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        button {
            padding: 12px 24px;
            font-size: 16px;
            cursor: pointer;
            margin: 5px;
            border: none;
            border-radius: 5px;
        }
        .btn-primary {
            background-color: #007bff;
            color: white;
        }
        .btn-primary:hover {
            background-color: #0056b3;
        }
        input[type="file"] {
            margin: 10px 0;
            padding: 10px;
        }
        .progress {
            margin: 10px 0;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 5px;
        }
        pre {
            background-color: #f4f4f4;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>ğŸ“„ TSV íŒŒì¼ â†’ Supabase ë°ì´í„° ì´ì „</h1>
    
    <div class="section">
        <h2>1ë‹¨ê³„: TSV íŒŒì¼ ì„ íƒ</h2>
        <input type="file" id="tsvFile" accept=".tsv" />
        <button class="btn-primary" onclick="loadTSV()">TSV íŒŒì¼ ë¡œë“œ</button>
        <div id="loadResult"></div>
    </div>

    <div class="section">
        <h2>2ë‹¨ê³„: ë°ì´í„° ë¯¸ë¦¬ë³´ê¸°</h2>
        <div id="previewResult"></div>
    </div>

    <div class="section">
        <h2>3ë‹¨ê³„: Supabaseë¡œ ë°ì´í„° ì´ì „</h2>
        <p><strong>ì£¼ì˜:</strong> ì´ ì‘ì—…ì€ ê¸°ì¡´ Supabase ë°ì´í„°ë¥¼ ë®ì–´ì”ë‹ˆë‹¤.</p>
        <button class="btn-primary" onclick="migrateToSupabase()">Supabaseë¡œ ì´ì „</button>
        <div id="migrateResult"></div>
    </div>

    <div class="section">
        <h2>4ë‹¨ê³„: ì´ì „ ê²°ê³¼ í™•ì¸</h2>
        <button class="btn-primary" onclick="verifyMigration()">Supabase ë°ì´í„° í™•ì¸</button>
        <div id="verifyResult"></div>
    </div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

        const supabaseUrl = 'https://eeyzenpolbrfmsamguvf.supabase.co';
        const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVleXplbnBvbGJyZm1zYW1ndXZmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMxNDg4NjcsImV4cCI6MjA3ODcyNDg2N30.cRxc6STLnhDI2Fm7jADLhhdko50esBNuYOkha3BC0-0';
        const supabase = createClient(supabaseUrl, supabaseAnonKey);

        let loadedQuestions = [];

        // TSV íŒŒì¼ íŒŒì‹±
        function parseTSV(tsvText) {
            const lines = tsvText.split('\n').filter(line => line.trim());
            if (lines.length === 0) {
                console.error('TSV íŒŒì¼ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.');
                return [];
            }

            console.log('ì´ ì¤„ ìˆ˜:', lines.length);
            console.log('ì²« ë²ˆì§¸ ì¤„:', lines[0]);

            // í—¤ë” ì œê±° (ì²« ë²ˆì§¸ ì¤„)
            const headers = lines[0].split('\t');
            console.log('í—¤ë”:', headers);
            const dataLines = lines.slice(1);

            const questions = dataLines.map((line, index) => {
                // íƒ­ìœ¼ë¡œ ë¶„ë¦¬
                const columns = line.split('\t');
                console.log(`ì¤„ ${index + 1} ì»¬ëŸ¼ ìˆ˜:`, columns.length, columns);
                
                // IDê°€ ì—†ìœ¼ë©´ ìë™ ìƒì„±
                let id = parseInt(columns[0]) || (index + 1);
                
                const question = {
                    id: id,
                    category: (columns[1] || '').trim() || 'ê¸°íƒ€',
                    question: (columns[2] || '').trim(),
                    option1: (columns[3] || '').trim(),
                    option2: (columns[4] || '').trim(),
                    option3: (columns[5] || '').trim(),
                    option4: (columns[6] || '').trim(),
                    answer: parseInt(columns[7]) || 1,
                    explanation: (columns[8] || '').trim(),
                    imageUrl: (columns[9] || '').trim() || undefined,
                    hasImage: !!(columns[9] && columns[9].trim()),
                    weight: 5
                };

                // standardì™€ detailItemì€ TSVì— ì—†ì„ ìˆ˜ ìˆìŒ
                if (columns[10]) question.standard = columns[10].trim();
                if (columns[11]) question.detailItem = columns[11].trim();
                if (columns[12]) question.weight = parseInt(columns[12]) || 5;

                return question;
            }).filter(q => {
                const isValid = q.question && q.question.length > 0;
                if (!isValid) {
                    console.warn('ìœ íš¨í•˜ì§€ ì•Šì€ ë¬¸ì œ:', q);
                }
                return isValid;
            });

            console.log('íŒŒì‹±ëœ ë¬¸ì œ ìˆ˜:', questions.length);
            return questions;
        }

        // 1ë‹¨ê³„: TSV íŒŒì¼ ë¡œë“œ
        window.loadTSV = function() {
            const fileInput = document.getElementById('tsvFile');
            const file = fileInput.files[0];
            
            if (!file) {
                document.getElementById('loadResult').innerHTML = 
                    '<div class="result error"><p>íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.</p></div>';
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const tsvText = e.target.result;
                    console.log('TSV í…ìŠ¤íŠ¸ ê¸¸ì´:', tsvText.length);
                    console.log('TSV í…ìŠ¤íŠ¸ ì²˜ìŒ 500ì:', tsvText.substring(0, 500));
                    
                    loadedQuestions = parseTSV(tsvText);
                    
                    if (loadedQuestions.length === 0) {
                        document.getElementById('loadResult').innerHTML = `
                            <div class="result error">
                                <h3>âš ï¸ ë¬¸ì œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</h3>
                                <p>TSV íŒŒì¼ì„ í™•ì¸í•´ì£¼ì„¸ìš”. ë¸Œë¼ìš°ì € ì½˜ì†”(F12)ì—ì„œ ìì„¸í•œ ë¡œê·¸ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                            </div>
                        `;
                        document.getElementById('previewResult').innerHTML = '';
                        return;
                    }
                    
                    document.getElementById('loadResult').innerHTML = `
                        <div class="result success">
                            <h3>âœ… TSV íŒŒì¼ ë¡œë“œ ì™„ë£Œ!</h3>
                            <p><strong>ì´ ${loadedQuestions.length}ê°œ ë¬¸ì œ</strong></p>
                        </div>
                    `;

                    // ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ
                    document.getElementById('previewResult').innerHTML = `
                        <div class="result info">
                            <h3>ğŸ“‹ ë°ì´í„° ë¯¸ë¦¬ë³´ê¸°</h3>
                            <p><strong>ì²« ë²ˆì§¸ ë¬¸ì œ:</strong></p>
                            <pre>${JSON.stringify(loadedQuestions[0], null, 2)}</pre>
                            ${loadedQuestions.length > 1 ? `<p><strong>ë‘ ë²ˆì§¸ ë¬¸ì œ:</strong></p><pre>${JSON.stringify(loadedQuestions[1], null, 2)}</pre>` : ''}
                        </div>
                    `;
                } catch (error) {
                    console.error('íŒŒì‹± ì˜¤ë¥˜:', error);
                    document.getElementById('loadResult').innerHTML = `
                        <div class="result error">
                            <h3>âŒ íŒŒì¼ íŒŒì‹± ì‹¤íŒ¨</h3>
                            <p>${error.message}</p>
                            <p>ë¸Œë¼ìš°ì € ì½˜ì†”(F12)ì—ì„œ ìì„¸í•œ ì˜¤ë¥˜ë¥¼ í™•ì¸í•˜ì„¸ìš”.</p>
                        </div>
                    `;
                }
            };
            reader.onerror = function() {
                document.getElementById('loadResult').innerHTML = 
                    '<div class="result error"><p>íŒŒì¼ ì½ê¸° ì‹¤íŒ¨</p></div>';
            };
            reader.readAsText(file, 'UTF-8');
        };

        // 3ë‹¨ê³„: Supabaseë¡œ ì´ì „
        window.migrateToSupabase = async function() {
            const resultDiv = document.getElementById('migrateResult');
            
            if (loadedQuestions.length === 0) {
                resultDiv.innerHTML = '<div class="result error"><p>ë¨¼ì € TSV íŒŒì¼ì„ ë¡œë“œí•´ì£¼ì„¸ìš”.</p></div>';
                return;
            }

            resultDiv.innerHTML = '<p>ì´ì „ ì¤‘...</p>';

            try {
                // ê¸°ì¡´ ë°ì´í„° ì‚­ì œ (ì„ íƒì‚¬í•­)
                const { error: deleteError } = await supabase
                    .from('questions')
                    .delete()
                    .neq('id', 0);

                if (deleteError && deleteError.code !== 'PGRST116') {
                    console.warn('ê¸°ì¡´ ë°ì´í„° ì‚­ì œ ê²½ê³ :', deleteError);
                }

                // ë°ì´í„° ì´ì „ (ë°°ì¹˜ë¡œ ë‚˜ëˆ ì„œ)
                const batchSize = 100;
                let successCount = 0;
                let errorCount = 0;
                const errors = [];

                for (let i = 0; i < loadedQuestions.length; i += batchSize) {
                    const batch = loadedQuestions.slice(i, i + batchSize);
                    
                    const { data, error } = await supabase
                        .from('questions')
                        .insert(batch);

                    if (error) {
                        console.error(`ë°°ì¹˜ ${i / batchSize + 1} ì˜¤ë¥˜:`, error);
                        errorCount += batch.length;
                        errors.push(`ë°°ì¹˜ ${i / batchSize + 1}: ${error.message}`);
                    } else {
                        successCount += batch.length;
                    }

                    // ì§„í–‰ ìƒí™© ì—…ë°ì´íŠ¸
                    resultDiv.innerHTML = `
                        <div class="progress">
                            <p>ì§„í–‰ ì¤‘... ${Math.min(i + batchSize, loadedQuestions.length)} / ${loadedQuestions.length}</p>
                        </div>
                    `;
                }

                let html = `
                    <div class="result success">
                        <h3>âœ… ë°ì´í„° ì´ì „ ì™„ë£Œ!</h3>
                        <p><strong>ì„±ê³µ:</strong> ${successCount}ê°œ</p>
                        <p><strong>ì‹¤íŒ¨:</strong> ${errorCount}ê°œ</p>
                    </div>
                `;

                if (errors.length > 0) {
                    html += `
                        <div class="result error">
                            <h4>ì˜¤ë¥˜ ìƒì„¸:</h4>
                            <pre>${errors.join('\n')}</pre>
                        </div>
                    `;
                }

                resultDiv.innerHTML = html;
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="result error">
                        <h3>âŒ ì´ì „ ì‹¤íŒ¨</h3>
                        <p>ì˜¤ë¥˜: ${error.message}</p>
                    </div>
                `;
            }
        };

        // 4ë‹¨ê³„: ì´ì „ ê²°ê³¼ í™•ì¸
        window.verifyMigration = async function() {
            const resultDiv = document.getElementById('verifyResult');
            resultDiv.innerHTML = '<p>í™•ì¸ ì¤‘...</p>';

            try {
                const { data: questions, error } = await supabase
                    .from('questions')
                    .select('*')
                    .limit(5);

                const { count } = await supabase
                    .from('questions')
                    .select('*', { count: 'exact', head: true });

                if (error) throw error;

                let html = '<div class="result success">';
                html += '<h3>âœ… Supabase ë°ì´í„° í™•ì¸</h3>';
                html += `<p><strong>ì´ ë¬¸ì œ ìˆ˜:</strong> ${count}ê°œ</p>`;
                html += '</div>';

                if (questions && questions.length > 0) {
                    html += '<div class="result info">';
                    html += '<h4>ìƒ˜í”Œ ë°ì´í„° (ìµœëŒ€ 5ê°œ):</h4>';
                    html += `<pre>${JSON.stringify(questions, null, 2)}</pre>`;
                    html += '</div>';
                }

                resultDiv.innerHTML = html;
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="result error">
                        <h3>âŒ í™•ì¸ ì‹¤íŒ¨</h3>
                        <p>ì˜¤ë¥˜: ${error.message}</p>
                    </div>
                `;
            }
        };
    </script>
</body>
</html>

